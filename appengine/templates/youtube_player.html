<html>
<head>
  <title></title>

  <link rel="stylesheet" type="text/css"
    href="/static/style.css" title="default"/>

  <script type="text/javascript"
    src="/static/jquery-1.4.2.min.js"></script>

  <script type="text/javascript"
    src="/static/partybox.js"></script>

  <script type="text/javascript"
    src="http://ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js"></script>

  <script type="text/javascript">

  var ytplayer = null;

  function SetupYouTubePlayer(url) {
    var params = { allowScriptAccess: "always" };
    var atts = { id: "ytplayerObj" };
    swfobject.embedSWF(url + "&playerapiid=ytplayerObj&enablejsapi=1",
        "playback", GetWidth(), GetHeight(),
        "8", null, null, params, atts);
  }

  function AddSongbox(container, title, thumbnails) {
    var clickWrapper = document.createElement('div');
    clickWrapper.setAttribute('class', 'clickWrapper');
    if (thumbnails.length) {
      var thumbnail = document.createElement('div');
      thumbnail.setAttribute('class', 'songThumb');
      var image = document.createElement('img');
      image.setAttribute('class', 'thumbnail');
      image.setAttribute('src', thumbnails[0]);
      thumbnail.appendChild(image);
      clickWrapper.appendChild(thumbnail);
    }
    var songDetails = document.createElement('div');
    songDetails.setAttribute('class', 'songDetails');
    songDetails.appendChild(document.createTextNode(title));
    clickWrapper.appendChild(songDetails);
    var row = document.createElement('div');
    row.setAttribute('class', 'songBox');
    row.appendChild(clickWrapper);
    container.appendChild(row);
    var clearFix = document.createElement('div');
    clearFix.setAttribute('class', 'clearfix');
    clearFix.appendChild(document.createTextNode(' '));
    container.appendChild(clearFix);
  }

  function UpdatePlaylist(results) {
    var songBoxes = document.getElementById('playlist');
    songBoxes.innerHTML = '';
    for (x in results) {
      AddSongbox(songBoxes, results[x]['title'], results[x]['thumbnails']);
    }
  }

  function SetSharingUrl() {
    var link = document.createElement('a');
    var url = window.location.protocol + '//' + window.location.host +
      '/youtube?p={{playlist}}';
    link.setAttribute('href', url);
    link.setAttribute('target', '_blank');
    link.appendChild(document.createTextNode(url));
    document.getElementById('sharing_url').appendChild(link);
  }

  function onYouTubePlayerReady(playerId) {
    ytplayer = document.getElementById('ytplayerObj');
    ytplayer.playVideo();
    ytplayer.addEventListener("onStateChange", "onYouTubeStateChange");
    ytplayer.addEventListener("onError", "onYouTubeError");
  }

  function onYouTubeStateChange(newState) {
    if (newState == 0) {
      PlayNextSong();
    }
  }

  function onYouTubeError(code) {
    // TODO(nav): Log an informative message to the console that there
    // was an error, and that we're skipping the track.
    PlayNextSong();
  }

  function SetCurrentSongTitle(title) {
    var e = document.getElementById('currSongTitle');
    if (!e)
      return;
    e.innerHTML = '';
    e.appendChild(document.createTextNode(title));
  }

  function PlayNextSong() {
    var req = new XMLHttpRequest();
    req.open('GET', '/youtube/player/next', true);
    req.onreadystatechange = function() {
      if (req.readyState == 4 && req.status == 200) {
        var response = JSON.parse(req.responseText);
        if (ytplayer == null) {
          SetupYouTubePlayer(response.url);
        } else {
          ytplayer.loadVideoByUrl(response.url);
        }

        SetCurrentSongTitle(response.title);

        var nowPlaying = document.getElementById('nowPlaying');
        nowPlaying.innerHTML = '';
        AddSongbox(nowPlaying, response.title, response.thumbnails);

        // Update the playlist.
        DoGetPlaylist("{{playlist}}", UpdatePlaylist);
      }
    }
    req.send(null);
  }

  function GetHeight() {
    // -25px for the margins / paddings
    return $(window).height() - $("#grBoxHeader").height() - 
           $("#videoPlayerHeader").height() - 20;
  }

  function GetWidth() {
    // -something for the margins / paddings
    return $(window).width() - $("#rightContent").width() - 25;
  } 
  
  function AdjustVideoSize() {
    $("#ytplayerObj").attr("height", GetHeight()); 
    $("#ytplayerObj").attr("width", GetWidth()); 
  }

  function AdjustSize() {
    var height = $(window).height() - $('#grBoxHeader').height();
    var width = $(window).width();
    $("#videoPlayerBox").css("height", GetHeight() + 35);
    $("#videoPlayerBox").css("width", GetWidth());
    $("#mainContent").css("width", width);
    $("#mainContent").css("height", height);
    $("#songBoxes").css("height", height - $("#adsense").height() - 15);
    AdjustVideoSize();  
  }

  $(document).ready(function() {
    AdjustSize();
    $(window).bind('resize', AdjustSize);
    PlayNextSong();
    DoGetPlaylist("{{playlist}}", UpdatePlaylist);
  });

  </script>
</head>

<body>
  <div id="grBox">

    <div id="grBoxHeader">
      <div id="sharing_url">
      </div>
      <script type="text/javascript">SetSharingUrl();</script>
      <div id="grBoxHeaderRight">
        Some Right Content
      </div>
    </div>

    <div id="mainContent" style="width: 1920px; height: 1011px; ">
      <div id="leftContent">
        <div id="videoPlayerBox" style="height: 994px; width: 1454px; ">
          <div id="videoPlayerHeader">
            <div id="currSongTitle">
            </div>
            <div id="qualitySelector">
              <button type="button" onclick="javascript:PlayNextSong()">Next</button>
            </div>
          </div>
          <div id="playback">
            You need Flash Player 8+ and JavaScript enabled to view this video.
          </div>
        </div>
      </div>
      <div id="rightContent">
        <div id="adsense">
        </div>
        <div id="songBoxes" style="height: 936px; ">
          <div id="nowPlaying" class="songBox nowPlaying"></div>
          <div id="playlist"></div>
        </div>
      </div>
    </div>

  </div>
</body>

</html>
